在 Hyperledger Fabric **test-network** 环境中添加 Org3、Org4、Org5 是典型的**通道扩组织**操作，核心遵循「**生成新组织证书 → 配置并启动新组织节点 → 更新通道配置 → 新组织加入通道 → 同步链码配置**」的流程。test-network 基于 `cryptogen`（证书生成）+ `docker-compose`（节点管理）实现，以下是**分步可落地的完整操作指南**，适配 Fabric 2.x+ 版本（test-network 主流版本），全程复用 test-network 原有目录结构，无需重构基础网络。

### 前置准备
1. 进入 test-network 根目录（确保是 Fabric 官方 `fabric-samples/test-network` 路径）：
   ```bash
   cd ~/fabric-samples/test-network
   ```
2. 确保原有网络（Org1、Org2、Orderer）正常运行（若已关闭，执行 `./network.sh up` 启动）：
   ```bash
   ./network.sh up  # 仅启动节点，不创建通道（若已有通道test，可跳过）
   # 若需重新创建基础通道test，执行：./network.sh up createChannel -c test
   ```
3. 保留原有 `crypto-config` 证书目录（后续新增组织证书会追加，不覆盖 Org1/Org2）。

### 核心原则
1. 新组织（Org3/4/5）需与 Org1/Org2 遵循相同的**目录规范**（证书、配置、容器端口不冲突）；
2. 通道扩组织的核心是**更新通道配置区块**，将新组织的 MSP 定义加入通道配置；
3. 新组织节点启动后，需**单独加入现有通道**，并安装链码才能参与背书/查询；
4. 端口规划（避免与 Org1/Org2 冲突，关键！）：
   - Org1：Peer0=7051、Peer1=7056；Org2：Peer0=9051、Peer1=9056
   - **Org3**：Peer0=11051、Peer1=11056；**Org4**：Peer0=13051、Peer1=13056；**Org5**：Peer0=15051、Peer1=15056
   - CA 端口：Org1CA=7054、Org2CA=9054；Org3CA=11054、Org4CA=13054、Org5CA=15054

---

## 第一步：修改证书生成配置，生成 Org3/4/5 证书
test-network 默认用 `cryptogen` 生成组织证书，需修改 `crypto-config.yaml` 配置文件，**追加 Org3、Org4、Org5 定义**（保留原有 Org1/Org2 配置，不可删除！）。
### 1.1 编辑 `crypto-config.yaml`
```bash
vim crypto-config.yaml
```
### 1.2 追加 Org3/4/5 配置（完整配置示例，替换原有内容或直接追加）
```yaml
# 顶级配置：Orderer组织（原有，保留）
OrdererOrgs:
  - Name: Orderer
    Domain: example.com
    Specs:
      - Hostname: orderer
# Peer组织：保留Org1/Org2，追加Org3/4/5（核心修改）
PeerOrgs:
  # 原有Org1，保留
  - Name: Org1
    Domain: org1.example.com
    EnableNodeOUs: true
    Template:
      Count: 2  # 2个Peer节点
    Users:
      Count: 1
  # 原有Org2，保留
  - Name: Org2
    Domain: org2.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
  # 新增Org3
  - Name: Org3
    Domain: org3.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
  # 新增Org4
  - Name: Org4
    Domain: org4.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
  # 新增Org5
  - Name: Org5
    Domain: org5.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
```
### 1.3 重新生成所有组织证书（覆盖原有证书，保留Org1/Org2信息）
```bash
# 先删除旧证书（可选，确保新证书生效）
rm -rf organizations/
# 用cryptogen生成证书（生成后自动放入organizations/目录）
cryptogen generate --config=./crypto-config.yaml
```
### 1.4 验证证书生成结果
```bash
ls organizations/peerOrganizations/
```
输出应包含 `org1.example.com`、`org2.example.com`、`org3.example.com`、`org4.example.com`、`org5.example.com`，说明证书生成成功。

---

## 第二步：创建新组织 Docker Compose 配置，启动 Org3/4/5 节点
test-network 用 `docker-compose` 管理节点容器，需为 Org3/4/5 创建**独立的 docker-compose 配置文件**（避免修改原有 `docker-compose-test-net.yaml`，降低冲突风险），配置内容包含：Peer0/Peer1 节点、CA 节点、CouchDB（状态数据库，可选）。
### 2.1 创建新配置文件 `docker-compose-org345.yaml`
```bash
vim docker-compose-org345.yaml
```
### 2.2 写入 Org3/4/5 完整容器配置（直接复制，端口已按规划配置）
```yaml
version: '2'
services:
  ###########################################################################
  # Org3 节点配置：Peer0、Peer1、CA、CouchDB
  ###########################################################################
  ca.org3.example.com:
    image: hyperledger/fabric-ca:latest
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca-org3
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=11054
    ports:
      - "11054:11054"
    command: sh -c 'fabric-ca-server start -b admin:adminpw -d'
    volumes:
      - ./organizations/peerOrganizations/org3.example.com/ca/:/etc/hyperledger/fabric-ca-server-config
    container_name: ca_org3
    networks:
      - test

  couchdb3:
    image: hyperledger/fabric-couchdb:latest
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - "11984:5984"
    container_name: couchdb3
    networks:
      - test

  peer0.org3.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer0.org3.example.com
      - CORE_PEER_ADDRESS=peer0.org3.example.com:11051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:11051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org3.example.com:11052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:11052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org3.example.com:11056
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org3.example.com:11051
      - CORE_PEER_LOCALMSPID=Org3MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_CHAINCODE_LOGGING_LEVEL=INFO
      - CORE_CHAINCODE_LOGGING_SHIM=INFO
      - CORE_LOGGING_LEVEL=INFO
      - CORE_PEER_STATE_STORE=couchdb
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb3:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org3.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "11051:11051"
    depends_on:
      - couchdb3
    container_name: peer0.org3.example.com
    networks:
      - test
    command: peer node start

  peer1.org3.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer1.org3.example.com
      - CORE_PEER_ADDRESS=peer1.org3.example.com:11056
      - CORE_PEER_LISTENADDRESS=0.0.0.0:11056
      - CORE_PEER_CHAINCODEADDRESS=peer1.org3.example.com:11057
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:11057
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org3.example.com:11051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org3.example.com:11056
      - CORE_PEER_LOCALMSPID=Org3MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_CHAINCODE_LOGGING_LEVEL=INFO
      - CORE_LOGGING_LEVEL=INFO
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org3.example.com/peers/peer1.org3.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org3.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "11056:11056"
    container_name: peer1.org3.example.com
    networks:
      - test
    command: peer node start

  ###########################################################################
  # Org4 节点配置：Peer0、Peer1、CA、CouchDB（端口1305*）
  ###########################################################################
  ca.org4.example.com:
    image: hyperledger/fabric-ca:latest
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca-org4
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=13054
    ports:
      - "13054:13054"
    command: sh -c 'fabric-ca-server start -b admin:adminpw -d'
    volumes:
      - ./organizations/peerOrganizations/org4.example.com/ca/:/etc/hyperledger/fabric-ca-server-config
    container_name: ca_org4
    networks:
      - test

  couchdb4:
    image: hyperledger/fabric-couchdb:latest
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - "13984:5984"
    container_name: couchdb4
    networks:
      - test

  peer0.org4.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer0.org4.example.com
      - CORE_PEER_ADDRESS=peer0.org4.example.com:13051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:13051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org4.example.com:13052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:13052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org4.example.com:13056
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org4.example.com:13051
      - CORE_PEER_LOCALMSPID=Org4MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_STATE_STORE=couchdb
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb4:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org4.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "13051:13051"
    depends_on:
      - couchdb4
    container_name: peer0.org4.example.com
    networks:
      - test
    command: peer node start

  peer1.org4.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer1.org4.example.com
      - CORE_PEER_ADDRESS=peer1.org4.example.com:13056
      - CORE_PEER_LISTENADDRESS=0.0.0.0:13056
      - CORE_PEER_CHAINCODEADDRESS=peer1.org4.example.com:13057
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:13057
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org4.example.com:13051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org4.example.com:13056
      - CORE_PEER_LOCALMSPID=Org4MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org4.example.com/peers/peer1.org4.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org4.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "13056:13056"
    container_name: peer1.org4.example.com
    networks:
      - test
    command: peer node start

  ###########################################################################
  # Org5 节点配置：Peer0、Peer1、CA、CouchDB（端口1505*）
  ###########################################################################
  ca.org5.example.com:
    image: hyperledger/fabric-ca:latest
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca-org5
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=15054
    ports:
      - "15054:15054"
    command: sh -c 'fabric-ca-server start -b admin:adminpw -d'
    volumes:
      - ./organizations/peerOrganizations/org5.example.com/ca/:/etc/hyperledger/fabric-ca-server-config
    container_name: ca_org5
    networks:
      - test

  couchdb5:
    image: hyperledger/fabric-couchdb:latest
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - "15984:5984"
    container_name: couchdb5
    networks:
      - test

  peer0.org5.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer0.org5.example.com
      - CORE_PEER_ADDRESS=peer0.org5.example.com:15051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:15051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org5.example.com:15052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:15052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org5.example.com:15056
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org5.example.com:15051
      - CORE_PEER_LOCALMSPID=Org5MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_STATE_STORE=couchdb
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb5:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org5.example.com/peers/peer0.org5.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org5.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "15051:15051"
    depends_on:
      - couchdb5
    container_name: peer0.org5.example.com
    networks:
      - test
    command: peer node start

  peer1.org5.example.com:
    image: hyperledger/fabric-peer:latest
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer1.org5.example.com
      - CORE_PEER_ADDRESS=peer1.org5.example.com:15056
      - CORE_PEER_LISTENADDRESS=0.0.0.0:15056
      - CORE_PEER_CHAINCODEADDRESS=peer1.org5.example.com:15057
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:15057
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org5.example.com:15051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org5.example.com:15056
      - CORE_PEER_LOCALMSPID=Org5MSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
    volumes:
      - /var/run/:/host/var/run/
      - ./organizations/peerOrganizations/org5.example.com/peers/peer1.org5.example.com/:/etc/hyperledger/fabric
      - ./organizations/peerOrganizations/org5.example.com/msp:/etc/hyperledger/fabric/msp
    ports:
      - "15056:15056"
    container_name: peer1.org5.example.com
    networks:
      - test
    command: peer node start

# 网络配置：复用test-network原有网络
networks:
  test:
    external: true
```
### 2.3 启动 Org3/4/5 所有节点
```bash
# 启动新组织容器（后台运行）
docker-compose -f docker-compose-org345.yaml up -d
```
### 2.4 验证节点启动状态
```bash
docker ps | grep -E "org3|org4|org5"
```
输出应包含 `peer0.org3/4/5`、`peer1.org3/4/5`、`ca_org3/4/5`、`couchdb3/4/5` 容器，且状态为 `Up`，说明启动成功。

---

## 第三步：更新现有通道配置，将 Org3/4/5 加入通道
Fabric 中**新组织无法直接参与现有通道**，需通过「**提取通道配置 → 编辑配置添加新组织MSP → 生成更新交易 → 原有组织签名并提交**」的流程，将 Org3/4/5 的 MSP 定义写入通道配置（以现有通道 `test` 为例）。
### 3.1 提取当前通道 `test` 的配置区块
```bash
# 1. 获取通道最新配置区块（写入config_block.pb）
peer channel fetch config config_block.pb -o localhost:7050 -c test --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
# 2. 将二进制配置区块转换为JSON格式（写入config.json）
configtxlator proto_decode --input config_block.pb --type common.Block --output config.json
# 3. 提取通道核心配置（写入modified_config.json，后续编辑此文件）
jq .data.data[0].payload.data.config config.json > modified_config.json
```
### 3.2 为 Org3/4/5 生成 MSP 配置片段（关键，通道配置需单独的MSP定义）
分别提取 Org3/4/5 的 MSP 配置，生成独立的 JSON 片段（后续追加到 `modified_config.json`）：
```bash
# 生成Org3 MSP配置片段（org3_msp.json）
jq -s '.[0] * {"channel_group":{"groups":{"Application":{"groups":{"Org3MSP":.[1]}}}}}' modified_config.json ./organizations/peerOrganizations/org3.example.com/msp/config.yaml | jq . > org3_msp.json
# 生成Org4 MSP配置片段（org4_msp.json）
jq -s '.[0] * {"channel_group":{"groups":{"Application":{"groups":{"Org4MSP":.[1]}}}}}' modified_config.json ./organizations/peerOrganizations/org4.example.com/msp/config.yaml | jq . > org4_msp.json
# 生成Org5 MSP配置片段（org5_msp.json）
jq -s '.[0] * {"channel_group":{"groups":{"Application":{"groups":{"Org5MSP":.[1]}}}}}' modified_config.json ./organizations/peerOrganizations/org5.example.com/msp/config.yaml | jq . > org5_msp.json
```
### 3.3 合并 MSP 配置到通道修改配置文件
将 Org3/4/5 的 MSP 配置依次追加到 `modified_config.json`：
```bash
# 合并Org3 → Org4 → Org5（顺序无关）
cp org3_msp.json modified_config.json
jq -s '.[0] * {"channel_group":{"groups":{"Application":{"groups":{"Org4MSP":.[1]}}}}}' modified_config.json ./organizations/peerOrganizations/org4.example.com/msp/config.yaml | jq . > modified_config.json
jq -s '.[0] * {"channel_group":{"groups":{"Application":{"groups":{"Org5MSP":.[1]}}}}}' modified_config.json ./organizations/peerOrganizations/org5.example.com/msp/config.yaml | jq . > modified_config.json
```
### 3.4 生成通道配置更新交易文件
```bash
# 1. 将原始配置和修改后配置转换为二进制格式
configtxlator proto_encode --input config.json --type common.Config --output config.pb
configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb
# 2. 计算配置差异，生成更新交易（update.pb）
configtxlator compute_update --channel_id test --original config.pb --updated modified_config.pb --output update.pb
# 3. 将二进制更新交易转换为JSON格式（update.json）
configtxlator proto_decode --input update.pb --type common.ConfigUpdate --output update.json
# 4. 封装成可提交的交易格式（final_update.json）
echo '{"payload":{"header":{"channel_header":{"channel_id":"test","type":2}},"data":{"config_update":'$(cat update.json)'}}}' | jq . > final_update.json
# 5. 转换为二进制交易文件（org345_update.tx，最终提交的文件）
configtxlator proto_encode --input final_update.json --type common.Envelope --output org345_update.tx
```
### 3.5 原有组织（Org1、Org2）签名并提交更新交易
通道配置修改需要满足**原有修改策略**（默认是 `OrdererMSP.Admins` 或 `Org1MSP.Admins + Org2MSP.Admins`），需用 Org1、Org2 的 Admin 身份签名后提交：
```bash
# 1. 切换为Org1 Admin身份（设置环境变量）
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051
# Org1签名更新交易
peer channel signconfigtx -f org345_update.tx

# 2. 切换为Org2 Admin身份，提交更新交易（最终生效）
export CORE_PEER_LOCALMSPID="Org2MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
export CORE_PEER_ADDRESS=localhost:9051
# 提交更新交易到Orderer，通道test将新增Org3/4/5
peer channel update -f org345_update.tx -c test -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
```
执行成功会输出 `Successfully submitted channel update`，说明通道配置更新完成，Org3/4/5 已被加入通道 `test`。

---

## 第四步：将 Org3/4/5 的 Peer 节点正式加入通道 `test`
通道配置更新后，新组织的 Peer 节点需**单独执行 join 命令**，才能同步通道账本并参与交易：
### 4.1 加入 Org3 Peer0/Peer1 到通道
```bash
# 切换为Org3 Admin身份
export CORE_PEER_LOCALMSPID="Org3MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
# Peer0加入通道
export CORE_PEER_ADDRESS=localhost:11051
peer channel join -b config_block.pb
# Peer1加入通道
export CORE_PEER_ADDRESS=localhost:11056
peer channel join -b config_block.pb
```
### 4.2 加入 Org4 Peer0/Peer1 到通道
```bash
# 切换为Org4 Admin身份
export CORE_PEER_LOCALMSPID="Org4MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp
# Peer0加入
export CORE_PEER_ADDRESS=localhost:13051
peer channel join -b config_block.pb
# Peer1加入
export CORE_PEER_ADDRESS=localhost:13056
peer channel join -b config_block.pb
```
### 4.3 加入 Org5 Peer0/Peer1 到通道
```bash
# 切换为Org5 Admin身份
export CORE_PEER_LOCALMSPID="Org5MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org5.example.com/peers/peer0.org5.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org5.example.com/users/Admin@org5.example.com/msp
# Peer0加入
export CORE_PEER_ADDRESS=localhost:15051
peer channel join -b config_block.pb
# Peer1加入
export CORE_PEER_ADDRESS=localhost:15056
peer channel join -b config_block.pb
```
✅ 每个 Peer 执行 `join` 后输出 `Successfully joined channel`，说明加入成功。

---

## 第五步：同步链码配置，让新组织参与交易
新组织节点加入通道后，**无任何链码信息**，需完成「**安装链码 → 批准链码定义 → 提交链码定义**」（Fabric 2.x+ 链码生命周期），才能参与背书、查询等交易操作（以原有链码 `test1` 为例）。
### 5.1 统一安装链码到 Org3/4/5 所有 Peer 节点
```bash
# 假设原有链码路径为chaincode/abstore，版本1.0，序列1（根据实际修改）
CHAINCODE_PATH=./chaincode/abstore
CHAINCODE_NAME=test1
CHAINCODE_VERSION=1.0
CHAINCODE_SEQ=1

# 安装到Org3 Peer0/1
export CORE_PEER_LOCALMSPID="Org3MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
export CORE_PEER_ADDRESS=localhost:11051
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz  # 若已有链码包，直接用包；无则先打包：peer lifecycle chaincode package ${CHAINCODE_NAME}.tar.gz --path ${CHAINCODE_PATH} --lang golang --label ${CHAINCODE_NAME}_${CHAINCODE_VERSION}
export CORE_PEER_ADDRESS=localhost:11056
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz

# 安装到Org4 Peer0/1
export CORE_PEER_LOCALMSPID="Org4MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp
export CORE_PEER_ADDRESS=localhost:13051
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz
export CORE_PEER_ADDRESS=localhost:13056
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz

# 安装到Org5 Peer0/1
export CORE_PEER_LOCALMSPID="Org5MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org5.example.com/peers/peer0.org5.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org5.example.com/users/Admin@org5.example.com/msp
export CORE_PEER_ADDRESS=localhost:15051
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz
export CORE_PEER_ADDRESS=localhost:15056
peer lifecycle chaincode install ${CHAINCODE_PATH}.tar.gz
```
### 5.2 批准并提交链码定义（包含新组织）
链码定义需**所有组织（Org1-5）批准**后，提交到通道生效（更新背书策略为包含 Org3-5）：
```bash
# 1. 查询链码安装ID（所有组织安装后ID相同，执行一次即可）
peer lifecycle chaincode queryinstalled | grep ${CHAINCODE_NAME}_${CHAINCODE_VERSION}
# 输出示例：Package ID: test1_1.0:abc123def456，复制abc123def456作为CC_PACKAGE_ID
export CC_PACKAGE_ID=test1_1.0:abc123def456

# 2. Org3/4/5分别批准链码定义（Org1/Org2已批准，无需重复）
## Org3批准
export CORE_PEER_LOCALMSPID="Org3MSP"
export CORE_PEER_ADDRESS=localhost:11051
peer lifecycle chaincode approveformyorg -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test --name ${CHAINCODE_NAME} --version ${CHAINCODE_VERSION} --package-id ${CC_PACKAGE_ID} --sequence ${CHAINCODE_SEQ} --signature-policy "AND('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer','Org4MSP.peer','Org5MSP.peer')"  # 背书策略：所有组织Peer共同背书，可根据需求修改为MAJORITY

## Org4批准
export CORE_PEER_LOCALMSPID="Org4MSP"
export CORE_PEER_ADDRESS=localhost:13051
peer lifecycle chaincode approveformyorg -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test --name ${CHAINCODE_NAME} --version ${CHAINCODE_VERSION} --package-id ${CC_PACKAGE_ID} --sequence ${CHAINCODE_SEQ} --signature-policy "AND('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer','Org4MSP.peer','Org5MSP.peer')"

## Org5批准
export CORE_PEER_LOCALMSPID="Org5MSP"
export CORE_PEER_ADDRESS=localhost:15051
peer lifecycle chaincode approveformyorg -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test --name ${CHAINCODE_NAME} --version ${CHAINCODE_VERSION} --package-id ${CC_PACKAGE_ID} --sequence ${CHAINCODE_SEQ} --signature-policy "AND('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer','Org4MSP.peer','Org5MSP.peer')"

# 3. 检查所有组织是否已批准（需显示Org1-5均为Approved）
peer lifecycle chaincode checkcommitreadiness --channelID test --name ${CHAINCODE_NAME} --version ${CHAINCODE_VERSION} --sequence ${CHAINCODE_SEQ} --signature-policy "AND('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer','Org4MSP.peer','Org5MSP.peer')" --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

# 4. 提交链码定义到通道（任意组织Admin执行即可）
peer lifecycle chaincode commit -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test --name ${CHAINCODE_NAME} --version ${CHAINCODE_VERSION} --sequence ${CHAINCODE_SEQ} --signature-policy "AND('Org1MSP.peer','Org2MSP.peer','Org3MSP.peer','Org4MSP.peer','Org5MSP.peer')" --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt --peerAddresses localhost:11051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt --peerAddresses localhost:13051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt --peerAddresses localhost:15051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org5.example.com/peers/peer0.org5.example.com/tls/ca.crt
```
✅ 提交成功输出 `Successfully committed chaincode definition`，说明链码配置同步完成。

---

## 第六步：验证新组织是否添加成功
### 6.1 验证通道组织列表
```bash
peer channel getinfo -c test -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
```
### 6.2 验证新组织Peer参与交易
执行链码调用/查询，**包含Org3/4/5的Peer地址**，验证背书成功：
```bash
peer chaincode invoke -o localhost:7050 --tls --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C test -n test1 --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt --peerAddresses localhost:11051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt --peerAddresses localhost:13051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt --peerAddresses localhost:15051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org5.example.com/peers/peer0.org5.example.com/tls/ca.crt -c '{"function":"Query","Args":["key1"]}'
```
若能正常返回结果，说明 **Org3/4/5 已成功加入 test-network 并参与交易**。

---

## 关键避坑点
1. **端口冲突**：严格按照规划的端口配置，否则容器启动失败（最常见问题）；
2. **证书一致性**：修改 `crypto-config.yaml` 后必须重新生成证书，否则新组织MSP无效；
3. **环境变量切换**：操作不同组织时，必须正确切换 `CORE_PEER_LOCALMSPID`、`CORE_PEER_ADDRESS` 等环境变量；
4. **背书策略更新**：新增组织后，必须更新链码背书策略包含新组织，否则调用时背书失败；
5. **容器网络**：新组织容器必须加入 test-network 原有网络 `test`（配置文件中已指定 `external: true`）；
6. **链码包一致性**：所有组织安装的链码包ID必须相同，否则批准/提交失败。

---

## 后续管理：停止/重启新组织节点
```bash
# 停止Org3/4/5节点
docker-compose -f docker-compose-org345.yaml down
# 重启Org3/4/5节点
docker-compose -f docker-compose-org345.yaml up -d
# 停止整个test-network（含Org1/2/3/4/5/Orderer）
./network.sh down && docker-compose -f docker-compose-org345.yaml down
```

以上就是在 test-network 中添加 Org3/4/5 的完整流程，全程遵循 Fabric 官方规范，可直接复用至其他新组织的添加操作。