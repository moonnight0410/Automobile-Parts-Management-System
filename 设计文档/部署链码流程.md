部署链码（以Hyperledger Fabric为例）到虚拟机中的示例网络（test-network）是联盟链部署的基础操作，以下是完整的步骤示例，基于Fabric 2.5+版本，虚拟机以Ubuntu 20.04为例：

### 前提条件
虚拟机已完成以下环境配置：
1. 安装Docker（20.10+）和Docker Compose
2. 安装Go 1.20+（链码开发/编译依赖）
3. 下载Fabric二进制文件、镜像（可通过官方脚本快速部署）
4. 输入命令gvm use go1.22.11切换go版本至开发版本
---

### 步骤1：启动Fabric示例网络（test-network）
#### 1.1 克隆Fabric源码并进入test-network目录
#### 已有无需操作
```bash
# 克隆Fabric仓库（按需指定版本，如2.5）
git clone --branch v2.5.0 https://github.com/hyperledger/fabric.git
cd fabric/test-network
```

#### 1.2 清理旧环境并启动网络
```bash
# 停止并删除旧容器、数据
./network.sh down

# 启动网络（创建通道mychannel，默认启动Org1、Org2、Orderer节点）
./network.sh up createChannel -c test -ca
# -ca：启动CA节点（可选，用于身份管理）
```

---

### 步骤2：准备链码（以Go语言示例链码为例）
#### 2.1 创建链码目录并编写基础链码
```bash
# 在根目录创建链码目录（避免网络清理时删除）
mkdir code
cd code
```

```
将链码从github中拉取下来：
https://github.com/moonnight0410/Automobile-Parts-Management-System.git

更新：
git pull
```

---

### 步骤3：安装链码到背书节点
链码需先安装到Org1和Org2的背书节点，再批准、提交链码定义。

#### 3.1 安装链码到Org1的peer节点
```bash
# 回到test-network目录
cd ~/fabric/fabric-samples/test-network

# 设置Org1的环境变量（指定peer节点、身份文件等）
export PATH=~/fabric/fabric-samples/bin:$PATH
export FABRIC_CFG_PATH=~/fabric/fabric-samples/config
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_MSPCONFIGPATH=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
# 安装链码（指定链码名称、版本、路径、语言）
peer chaincode install -n test1 -v 1.0 -p /home/jianyu-zou/code/Automobile-Parts-Management-System/chaincode -l golang
# 在链码目录中打包（选择该方法安装链码）
cd /home/jianyu-zou/code/Automobile-Parts-Management-System/chaincode
peer lifecycle chaincode package test1.tar.gz --lang golang --path . --label test1_1.0
#安装链码
peer lifecycle chaincode install test1.tar.gz
#获取包ID（安装成功后显示）
peer lifecycle chaincode queryinstalled
#查询绝对路径命令
realpath chaincode
#全局环境变量设置
# 打开 .bashrc 文件进行编辑
nano ~/.bashrc
# Fabric 环境变量（永久生效）（已设置）
export PATH=~/fabric/fabric-samples/bin:$PATH
export FABRIC_CFG_PATH=~/fabric/fabric-samples/config
#手动触发生效
source ~/.bashrc
```

#### 3.2 安装链码到Org2的peer节点
```bash
# 切换为Org2的环境变量（在test-network目录）
export CORE_PEER_LOCALMSPID="Org2MSP"
export CORE_PEER_MSPCONFIGPATH=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
export CORE_PEER_ADDRESS=localhost:9051
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
# 重复安装命令（在code/chaincode目录）
peer lifecycle chaincode install test1.tar.gz
#获取包ID（安装成功后显示）
peer lifecycle chaincode queryinstalled
```

---

### 步骤4：批准链码定义（Org1/Org2分别批准）
Fabric 2.x+需先由各组织批准链码定义，再提交到通道。

#### 4.1 Org1批准链码定义
```bash
# 切回Org1环境变量
export PATH=~/fabric/fabric-samples/bin:$PATH
export FABRIC_CFG_PATH=~/fabric/fabric-samples/config
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_MSPCONFIGPATH=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt

# 查看已安装的链码，提取Package ID
peer lifecycle chaincode queryinstalled
export Package_ID='test1_1.0:5c436dc1d5b1eb5f859f4ea3333ed2b087b87c40d0991c2a430266ff2c45db05'（示例）
#赋值PackageID
echo "Package ID: $PACKAGE_ID"

# 批准链码定义
peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls true --cafile ~/fabric/fabric-samples/test-network/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test -n test1 --version 1.0 --sequence 1 --package-id test1_1.0:5c436dc1d5b1eb5f859f4ea3333ed2b087b87c40d0991c2a430266ff2c45db05 --init-required
# --init-required：链码需要初始化；--sequence：版本序列（首次为1）
```
#### 4.1.1 查看已批准的链码定义
```bash
# 查看已批准的链码定义
peer lifecycle chaincode checkcommitreadiness --channelID test -n test1 --version 1.0 --sequence 1 --tls --cafile ~/fabric/fabric-samples/test-network/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
```
#### 4.1.2 审计成功返回
```bash
2026-01-29 22:34:39.507 CST 0001 INFO [chaincodeCmd] ClientWait -> txid [a94320bf3c3e6b88ec5e4aefafeeddbbe9a054157a9faff03f68c5647cacf955] committed with status (VALID) at localhost:7051

```

#### 4.2 Org2批准链码定义
```bash
# 切回Org2环境变量
export CORE_PEER_LOCALMSPID="Org2MSP"
export CORE_PEER_MSPCONFIGPATH=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
export CORE_PEER_ADDRESS=localhost:9051
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt

# 执行批准命令（参数与Org1一致）
peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls true --cafile ~/fabric/fabric-samples/test-network/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test -n test1 --version 1.0 --sequence 1 --package-id test1_1.0:5c436dc1d5b1eb5f859f4ea3333ed2b087b87c40d0991c2a430266ff2c45db05 --init-required
```
#### 4.2.1 查看已批准的链码定义
```bash
# 查看已批准的链码定义
peer lifecycle chaincode checkcommitreadiness --channelID test -n test1 --version 1.0 --sequence 1 --tls --cafile ~/fabric/fabric-samples/test-network/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
```
#### 4.2.2 审计成功返回
```bash
2026-01-29 22:34:39.507 CST 0001 INFO [chaincodeCmd] ClientWait -> txid [a94320bf3c3e6b88ec5e4aefafeeddbbe9a054157a9faff03f68c5647cacf955] committed with status (VALID) at localhost:9051

```
---

### 步骤5：提交链码定义到通道
```bash
# 提交链码定义（任意组织执行即可，此处用Org1）
export PATH=~/fabric/fabric-samples/bin:$PATH
export FABRIC_CFG_PATH=~/fabric/fabric-samples/config
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_MSPCONFIGPATH=~/fabric/fabric-samples/test-network/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt

peer lifecycle chaincode commit -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls true --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --channelID test --name test1 --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt --version 1.0 --sequence 1 --init-required

```
##### 5.2.1 查看已提交的链码定义
```bash
# 查看已提交的链码定义
peer lifecycle chaincode checkcommitreadiness --channelID test -n test1 --version 1.0 --sequence 1 --tls true --cafile ~/fabric/fabric-samples/test-network/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json

peer lifecycle chaincode checkcommitreadiness --channelID mychannel --name fabcar --version 1.0 --sequence 1 --tls true --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json

```
##### 5.2.2 审计成功返回
```bash
2026-01-29 22:34:39.507 CST 0001 INFO [chaincodeCmd] ClientWait -> txid [a94320bf3c3e6b88ec5e4aefafeeddbbe9a054157a9faff03f68c5647cacf955] committed with status (VALID) at localhost:7051

```
---

### 步骤6：初始化并测试链码
#### 6.1 初始化链码（执行InitLedger方法）
```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls true --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C test -n test1 --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt --isInit -c '{"function":"initLedger","Args":[]}'
# --isInit：标记为初始化调用
```
#### 6.2 测试CreatePart
```bash
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls true --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C test -n test1 --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"CreatePart","Args":["{\"partID\":\"ENG-PISTON-002\",\"vin\":\"LVX432109876543210\",\"batchNo\":\"B20250502\",\"name\":\"发动机活塞\",\"type\":\"发动机部件\",\"manufacturer\":\"厂商B\",\"createTime\":\"1735689600\",\"status\":\"NORMAL\"}"]}'
```
#### 6.2 查询链码数据(测试QueryPart)
```bash
peer chaincode query -C test -n test1 -c '{"Args":["QueryPart","ENG-PISTON-002"]}'
# 预期输出：{\"partID\":\"ENG-PISTON-002\",\"vin\":\"LVX432109876543210\",\"batchNo\":\"B20250502\",\"name\":\"发动机活塞\",\"type\":\"发动机部件\",\"manufacturer\":\"厂商B\",\"createTime\":\"1735689600\",\"status\":\"NORMAL\"}
```

---

### 关键注意事项
1. 链码路径：需确保`peer chaincode install`的`-p`参数指向链码源码的**绝对路径**（虚拟机内）。
2. 环境变量：每次切换Org1/Org2时，必须重新设置`CORE_PEER_*`系列环境变量，否则会因身份/节点错误导致部署失败。
3. 镜像依赖：若链码编译/运行失败，检查Fabric链码镜像（如`hyperledger/fabric-ccenv:2.5`）是否已正确拉取。
4. 清理网络：部署完成后，可通过`./network.sh down`停止网络并清理数据（链码源码不会被删除）。

如果使用Node.js/Python链码，仅需修改`peer chaincode install`的`-l`参数（如`-l node`/`-l python`），并确保对应语言的链码语法符合Fabric规范。